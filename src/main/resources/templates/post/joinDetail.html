<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>모집-상세</title>
    <link rel="stylesheet" th:href="@{/css/post/joinDetail.css}">
    <script>
        var postId = `[[${post.postId}]]`;
        console.log("===============postId======================");
        console.log(postId);
        console.log("===========================================");

        document.addEventListener("DOMContentLoaded", function () {
            // 페이지 로드될 때 댓글을 가져오는 함수 호출
            loadComments(1);
        });

        // 댓글을 가져와서 HTML에 표시하는 함수
        function loadComments(page) {
            // Ajax를 사용하여 서버에서 특정 페이지의 댓글 데이터를 가져옵니다.
            fetch("/post/comment?postId=" + postId + "&page=" + page)
                .then(response => response.json()) // JSON 데이터로 변환
                .then(data => {
                    // 서버에서 받은 데이터를 처리하여 HTML에 표시
                    displayComments(data.dtoList);
                    // 페이징 버튼을 생성합니다.
                    displayPagination(data);
                })
                .catch(error => {
                    console.error('댓글을 불러오는 중 에러가 발생했습니다:', error);
                });
        }

        // 댓글을 HTML에 표시하는 함수
        function displayComments(comments) {
            var commentList = document.getElementById("commentList");
            commentList.innerHTML = ''; // 기존 댓글을 지웁니다.

            comments.forEach(function (comment) {
                // 각 댓글을 리스트 아이템으로 추가
                var li = document.createElement('li');
                li.innerHTML = `<p>${comment.member.name}</p><p>${comment.commentContent}</p><p>${comment.regisgerDate}</p>`;
                commentList.appendChild(li);
            });
        }

        // 페이징 버튼을 생성하는 함수
        function displayPagination(data) {
            var pagination = document.getElementById("pagination");
            pagination.innerHTML = ''; // 기존 페이징 버튼을 지웁니다.

            var totalPages = Math.ceil(data.total / data.size); // 전체 페이지 수 계산

            for (var i = 1; i <= totalPages; i++) {
                var button = document.createElement('button');
                button.textContent = i;
                button.addEventListener("click", function () {
                    loadComments(this.textContent); // 버튼을 클릭하면 해당 페이지의 댓글을 가져옵니다.
                });
                pagination.appendChild(button);
            }
        }
    </script>
</head>
<body>
<div th:include="/include/header.html"></div>
<div class="container"></div>
<div class="details">
    <div class="left">
        <th:block th:each="image : ${imageDTOS}">
            <img th:src="@{'/api/photo/' + ${image.uuid} + '_' + ${image.fileName}}"
                 alt="Uploaded Image"
                 th:onerror="@{/images/default.jpg}">
        </th:block>
    </div>
    <div class="description">
        <h2 th:text="${post.title}"></h2>
        <div class="info">
            <img th:src="@{/image/map.png}" alt="여행지">
            <p id="position">여행지</p>
            <img th:src="@{/image/people.png}" alt="인원">
            <p id="number" th:text="'모집 인원 : ' + ${post.numPeople}">희망 인원</p>
            <p th:text=" '예산 : ' + ${post.expense} + '원'">예상 예산</p>
            <img th:src="@{/image/calendar.png}" alt="일정">
            <p id="cal">
                출국 : [[${#temporals.format(post.startTravelDate, 'yyyy-MM-dd')}]] <br>귀국 : [[${#temporals.format(post.endTravelDate.plusDays(21), 'yyyy-MM-dd')}]]</p>
        </div>
        <p id="content2" th:text="${post.content}">게시글 내용</p>
        <p id="commentH">댓글 </p>
        <!--      <div class="comment">-->
        <!--        <div class="profile-info">-->
        <!--          <img th:src="@{/image/cat.jpeg}" alt="프로필 사진">-->
        <!--        </div>-->
        <!--        <div>-->
        <!--          <h4 class="nickname">김시언 잇프제 대전</h4>-->
        <!--          <span class="nickname"> 안사요 안산다고요 안사요...</span>-->
        <!--        </div>-->
        <!--      </div>-->
        <form th:action="@{/post/comment}" method="post">
            <input type="hidden" name="postId" th:value="${post.postId}" />
            <input type="hidden" name="memberId" th:value="${memberId}" />
            <input type="text" name="commentContent" id="comment-input" placeholder="댓글을 입력하세요">
            <button type="submit">입력</button>
        </form>
        <div class="comment">
            <ul id="commentList">
                <li></li>
            </ul>
            <div id="pagination">
            </div>
        </div> <!--comment-->
    </div>
</div>
</div>
<script src="//t1.daumcdn.net/mapjsapi/bundle/postcode/prod/postcode.v2.js"></script>
<script src="//dapi.kakao.com/v2/maps/sdk.js?appkey=f982e13e4f6fb5fa544e2ca4883ced76&libraries=services"></script>

<script th:inline="javascript">


    document.addEventListener("DOMContentLoaded", function () {
        createKakaoMap();
    });

    function createKakaoMap() {
        // 카카오맵을 표시할 위치
        var container = document.getElementById('map');

        // 중심 좌표 설정
        var centerLatLng = new kakao.maps.LatLng([[${post.locationX}]], [[${post.locationY}]]); // Thymeleaf 문법을 사용하여 서버에서 전달된 post의 locationX와 locationY 값을 가져옵니다.

        // 지도 옵션 설정
        var options = {
            center: centerLatLng,
            level: 3
        };

        // 지도 생성
        var map = new kakao.maps.Map(container, options);

        // 마커 생성
        var marker = new kakao.maps.Marker({
            position: centerLatLng // 마커가 표시될 위치
        });

        // 마커 지도에 추가
        marker.setMap(map);
    }
</script>

<script>
    form.addEventListener("submit", function(e) {
        e.preventDefault();
        const formData = new FormData(form);
        const postData = new URLSearchParams();

        for (const pair of formData.entries()) {
            postData.append(pair[0], pair[1]);
        }

        // 폼 데이터로부터 postId 추출
        const postId = formData.get("postId");

        fetch(`/post/comment?postId=${postId}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
            },
            body: postData
        })
            .then(response => response.json())
            .then(data => {
                if (data.id) { // 서버에서 응답받은 데이터에 id가 포함되어 있는 경우
                    const commentItem = document.createElement("li");
                    commentItem.textContent = `${data.authorName}: ${data.content}`; // 작성자 이름과 내용을 표시
                    commentList.appendChild(commentItem);
                    form.reset(); // 폼 초기화
                } else {
                    alert("Error: " + data.message);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert("Error posting comment: " + error.message);
            });
    });
</script>
</body>

</html>