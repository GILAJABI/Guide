<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>í›„ê¸°-ìƒì„¸</title>
    <link rel="stylesheet" th:href="@{/css/post/reviewDetail.css}">
    <script>
        var postId = `[[${post.postId}]]`;
        console.log("===============postId======================");
        console.log(postId);
        console.log("===========================================");

        document.addEventListener("DOMContentLoaded", function () {
            // í˜ì´ì§€ ë¡œë“œë  ë•Œ ëŒ“ê¸€ì„ ê°€ì ¸ì˜¤ëŠ” í•¨ìˆ˜ í˜¸ì¶œ
            loadComments(1);
        });

        // ëŒ“ê¸€ì„ ê°€ì ¸ì™€ì„œ HTMLì— í‘œì‹œí•˜ëŠ” í•¨ìˆ˜
        function loadComments(page) {
            // Ajaxë¥¼ ì‚¬ìš©í•˜ì—¬ ì„œë²„ì—ì„œ íŠ¹ì • í˜ì´ì§€ì˜ ëŒ“ê¸€ ë°ì´í„°ë¥¼ ê°€ì ¸ì˜µë‹ˆë‹¤.
            fetch("/post/comment?postId=" + postId + "&page=" + page)
                .then(response => response.json()) // JSON ë°ì´í„°ë¡œ ë³€í™˜
                .then(data => {
                    // ì„œë²„ì—ì„œ ë°›ì€ ë°ì´í„°ë¥¼ ì²˜ë¦¬í•˜ì—¬ HTMLì— í‘œì‹œ
                    displayComments(data.dtoList);
                    // í˜ì´ì§• ë²„íŠ¼ì„ ìƒì„±í•©ë‹ˆë‹¤.
                    displayPagination(data);
                })
                .catch(error => {
                    console.error('ëŒ“ê¸€ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì—ëŸ¬ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤:', error);
                });
        }

        // ëŒ“ê¸€ì„ HTMLì— í‘œì‹œí•˜ëŠ” í•¨ìˆ˜
        function displayComments(comments) {
            var commentList = document.getElementById("commentList");
            commentList.innerHTML = ''; // ê¸°ì¡´ ëŒ“ê¸€ì„ ì§€ì›ë‹ˆë‹¤.

            comments.forEach(function (comment) {
                // ê° ëŒ“ê¸€ì„ ë¦¬ìŠ¤íŠ¸ ì•„ì´í…œìœ¼ë¡œ ì¶”ê°€
                var li = document.createElement('li');
                li.innerHTML = `<p>${comment.member.name}</p><p>${comment.commentContent}</p>`;
                commentList.appendChild(li);
            });
        }

        // í˜ì´ì§• ë²„íŠ¼ì„ ìƒì„±í•˜ëŠ” í•¨ìˆ˜
        function displayPagination(data) {
            var pagination = document.getElementById("pagination");
            pagination.innerHTML = ''; // ê¸°ì¡´ í˜ì´ì§• ë²„íŠ¼ì„ ì§€ì›ë‹ˆë‹¤.

            var totalPages = Math.ceil(data.total / data.size); // ì „ì²´ í˜ì´ì§€ ìˆ˜ ê³„ì‚°

            for (var i = 1; i <= totalPages; i++) {
                var button = document.createElement('button');
                button.textContent = i;
                button.addEventListener("click", function () {
                    loadComments(this.textContent); // ë²„íŠ¼ì„ í´ë¦­í•˜ë©´ í•´ë‹¹ í˜ì´ì§€ì˜ ëŒ“ê¸€ì„ ê°€ì ¸ì˜µë‹ˆë‹¤.
                });
                pagination.appendChild(button);
            }
        }
    </script>
</head>

<body>
<div th:include="/include/header.html"></div>
<div class="container">
    <div id="aaa">
        <div id="selectMenu">
            <a th:href="@{/post/joinMain}">ëª¨ì§‘</a>
            <a th:href="@{/post/reviewMain}" style="color:#FF6392">í›„ê¸°</a>
            <a th:href="@{/post/carrotMain}">ê±°ë˜</a>
        </div>
        <div th:if= "${session.member_id == post.getMemberId()}">
            <form th:action="@{/post/delete/{postId}(postId=${post.postId})}" method="post">
                <input type="hidden" name="postId" th:value="${post.postId}" />
                <input type="hidden" name="memberId" th:value="${post.memberId}"/>
                <button type="submit" style="background-color: #363636;">ì‚­ì œ</button>
            </form>
        </div>
    </div>
    <section>
        <th:block th:each="image : ${post.imageDTOs}">
            <img th:src="@{'/api/photo/' + ${image.uuid} + '_' + ${image.fileName}}" alt="Uploaded Image" class="img" th:onerror="@{/images/default.jpg}">
        </th:block>
        <div class="sec-container">
            <div id="left">
                <p class="regDate" id="dateCSS">[[${#temporals.format(post.registerDate, 'yyyy-MM-dd')}]]</p>
                <!--                <div class="view">-->
                <!--                    <p th:text="'ğŸ‘€  ' + ${post.views} + ' ëª…ì´ ì¡°íšŒí–ˆì–´ìš”'"></p>-->
                <!--                </div>-->
                <div class="icons">
                    <img th:src="@{/image/eye.png}" alt="ì¡°íšŒìˆ˜ ì•„ì´ì½˜" id="viewIcon">
                    <p class="icon-text" th:text="'ì¡°íšŒìˆ˜ ' + ${post.views}">ì¡°íšŒìˆ˜</p>
                </div>
                <p id="title" th:text="${post.title}"></p>
                <p class="text">ì—¬í–‰ì •ë³´</p>
                <div class="infoBox">
                    <p th:text="'ğŸ“ í‰ì  : ' + ${post.grade}"></p>
                    <p th:text="'ğŸ’° ì´ ê²½ë¹„ : ' + ${post.expense} + 'ì›'"></p>
                    <p>ğŸ—“ï¸ ì—¬í–‰ ì‹œì‘ ë‚ ì§œ : [[${#temporals.format(post.startTravelDate, 'yyyy-MM-dd')}]]</p>
                    <p>ğŸ—“ ì—¬í–‰ ì¢…ë£Œ ë‚ ì§œ : [[${#temporals.format(post.endTravelDate, 'yyyy-MM-dd')}]]</p>
                </div>
                <p class="text">í›„ê¸°ê¸€</p>
                <p id="content" th:text="${post.content}"></p>
                <p class="text">ëŒ“ê¸€</p>
                <p id="commentCnt" th:text="'ëŒ“ê¸€ ' + ${post.commentCount} + 'ê°œ'"></p>
                <form id="comment-form" th:action="@{/post/comment}" method="post">
                    <input type="hidden" name="postId" th:value="${post.postId}" />
                    <input type="hidden" name="memberId" th:value="${post.memberId}" />
                    <input type="text" name="commentContent" id="comment-input" placeholder="ëŒ“ê¸€ì„ ì…ë ¥í•˜ì„¸ìš”">
                    <button type="button" id="comment-button">ì…ë ¥</button>
                </form>

                <div class="comment">
                    <ul id="commentList">
                        <li></li>
                    </ul>
                    <div id="pagination">
                    </div>
                </div> <!--comment-->
            </div> <!--left-->
            <div id="right">
                <p class="text" id="sell">ì—¬í–‰ì</p>
                <div class="user">
                    <div class="go">
                        <p id="name" th:text="${post.memberName} + 'ë‹˜ í”„ë¡œí•„ ì •ë³´'"></p>
                        <a th:href="@{/member/otherPage/{memberId}(memberId=${post.memberId})}">
                            <button type="submit" id="go">ë³´ëŸ¬ê°€ê¸°</button>
                        </a>
                    </div>
                </div> <!--user-->
                <p class="text" id="loc">ìœ„ì¹˜</p>
                <div id="map" style="width:380px;height:480px;margin-top: 10px;margin-left: 10px;">
                    <!--                    <iframe src="https://www.google.com/maps/embed?pb=!1m18!1m12!1m3!1d35799.901099154966!2d126.99122613009443!3d37.52456387269132!2m3!1f0!2f0!3f0!3m2!1i1024!2i768!4f13.1!3m3!1m2!1s0x357ca15aee9ab0cb%3A0x31793fc63e0cf9d3!2z67mE7Yq47Lqg7ZSE!5e0!3m2!1sko!2skr!4v1709707618933!5m2!1sko!2skr"-->
                    <!--                            width="600" height="450" style="border:0;" allowfullscreen="" loading="lazy"-->
                    <!--                            referrerpolicy="no-referrer-when-downgrade">-->
                    <!--                    </iframe>-->
                </div>
            </div> <!--right-->
        </div> <!--sec-container-->
    </section>
</div> <!--controller-->

<script src="//t1.daumcdn.net/mapjsapi/bundle/postcode/prod/postcode.v2.js"></script>
<script src="//dapi.kakao.com/v2/maps/sdk.js?appkey=f982e13e4f6fb5fa544e2ca4883ced76&libraries=services"></script>
<script th:src="@{/js/post/commentSession.js}"></script>
<script th:inline="javascript">


    document.addEventListener("DOMContentLoaded", function () {
        createKakaoMap();
    });

    function createKakaoMap() {
        // ì¹´ì¹´ì˜¤ë§µì„ í‘œì‹œí•  ìœ„ì¹˜
        var container = document.getElementById('map');

        // ì¤‘ì‹¬ ì¢Œí‘œ ì„¤ì •
        var centerLatLng = new kakao.maps.LatLng([[${post.locationX}]], [[${post.locationY}]]); // Thymeleaf ë¬¸ë²•ì„ ì‚¬ìš©í•˜ì—¬ ì„œë²„ì—ì„œ ì „ë‹¬ëœ postì˜ locationXì™€ locationY ê°’ì„ ê°€ì ¸ì˜µë‹ˆë‹¤.

        // ì§€ë„ ì˜µì…˜ ì„¤ì •
        var options = {
            center: centerLatLng,
            level: 10
        };

        // ì§€ë„ ìƒì„±
        var map = new kakao.maps.Map(container, options);

        // ë§ˆì»¤ ìƒì„±
        var marker = new kakao.maps.Marker({
            position: centerLatLng // ë§ˆì»¤ê°€ í‘œì‹œë  ìœ„ì¹˜
        });

        // ë§ˆì»¤ ì§€ë„ì— ì¶”ê°€
        marker.setMap(map);
    }
</script>
<script>
    form.addEventListener("submit", function(e) {
        e.preventDefault();
        const formData = new FormData(form);
        const postData = new URLSearchParams();

        for (const pair of formData.entries()) {
            postData.append(pair[0], pair[1]);
        }

        // í¼ ë°ì´í„°ë¡œë¶€í„° postId ì¶”ì¶œ
        const postId = formData.get("postId");

        fetch(`/post/comment?postId=${postId}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
            },
            body: postData
        })
            .then(response => response.json())
            .then(data => {
                if (data.id) { // ì„œë²„ì—ì„œ ì‘ë‹µë°›ì€ ë°ì´í„°ì— idê°€ í¬í•¨ë˜ì–´ ìˆëŠ” ê²½ìš°
                    const commentItem = document.createElement("li");
                    commentItem.textContent = `${data.authorName}: ${data.content}`; // ì‘ì„±ì ì´ë¦„ê³¼ ë‚´ìš©ì„ í‘œì‹œ
                    commentList.appendChild(commentItem);
                    form.reset(); // í¼ ì´ˆê¸°í™”
                } else {
                    alert("Error: " + data.message);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert("Error posting comment: " + error.message);
            });
    });
</script>
<footer>
    <div th:include="/include/footer.html"></div>
</footer>
</body>

</html>