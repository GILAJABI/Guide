<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <link rel="stylesheet" th:href="@{/css/post/reviewDetail.css}">
    <script>
        var postId = `[[${post.postId}]]`;
        console.log("===============postId======================");
        console.log(postId);
        console.log("===========================================");

        document.addEventListener("DOMContentLoaded", function () {
            // 페이지 로드될 때 댓글을 가져오는 함수 호출
            loadComments(1);
        });

        // 댓글을 가져와서 HTML에 표시하는 함수
        function loadComments(page) {
            // Ajax를 사용하여 서버에서 특정 페이지의 댓글 데이터를 가져옵니다.
            fetch("/post/comment?postId=" + postId + "&page=" + page)
                .then(response => response.json()) // JSON 데이터로 변환
                .then(data => {
                    // 서버에서 받은 데이터를 처리하여 HTML에 표시
                    displayComments(data.dtoList);
                    // 페이징 버튼을 생성합니다.
                    displayPagination(data);
                })
                .catch(error => {
                    console.error('댓글을 불러오는 중 에러가 발생했습니다:', error);
                });
        }

        // 댓글을 HTML에 표시하는 함수
        function displayComments(comments) {
            var commentList = document.getElementById("commentList");
            commentList.innerHTML = ''; // 기존 댓글을 지웁니다.

            comments.forEach(function (comment) {
                // 각 댓글을 리스트 아이템으로 추가
                var li = document.createElement('li');
                li.innerHTML = `<p>${comment.member.name}</p><p>${comment.commentContent}</p><p>${comment.regisgerDate}</p>`;
                commentList.appendChild(li);
            });
        }

        // 페이징 버튼을 생성하는 함수
        function displayPagination(data) {
            var pagination = document.getElementById("pagination");
            pagination.innerHTML = ''; // 기존 페이징 버튼을 지웁니다.

            var totalPages = Math.ceil(data.total / data.size); // 전체 페이지 수 계산

            for (var i = 1; i <= totalPages; i++) {
                var button = document.createElement('button');
                button.textContent = i;
                button.addEventListener("click", function () {
                    loadComments(this.textContent); // 버튼을 클릭하면 해당 페이지의 댓글을 가져옵니다.
                });
                pagination.appendChild(button);
            }
        }
    </script>
</head>

<body>
<div th:include="/include/header.html"></div>
<div class="container">
    <div id="selectMenu">
        <a th:href="@{/post/joinMain}">모집</a>
        <a th:href="@{/post/reviewMain}">후기</a>
        <a th:href="@{/post/carrotMain}" style="color:#FF6392">거래</a>
    </div>
    <div class="cont">

        <div class="bottom">
            <div class="left">
                <th:block th:each="image : ${imageDTOS}">
                    <img th:src="@{'/api/photo/' + ${image.uuid} + '_' + ${image.fileName}}"
                         alt="Uploaded Image"
                         th:onerror="@{/images/default.jpg}">
                </th:block>
                <div class="location-map">

                    <iframe
                            src="https://www.google.com/maps/embed?pb=!1m18!1m12!1m3!1d35799.901099154966!2d126.99122613009443!3d37.52456387269132!2m3!1f0!2f0!3f0!3m2!1i1024!2i768!4f13.1!3m3!1m2!1s0x357ca15aee9ab0cb%3A0x31793fc63e0cf9d3!2z67mE7Yq47Lqg7ZSE!5e0!3m2!1sko!2skr!4v1709707618933!5m2!1sko!2skr"
                            width="600" height="450" style="border:0;" allowfullscreen="" loading="lazy"
                            referrerpolicy="no-referrer-when-downgrade"></iframe>
                </div>
            </div>

            <div class="right">
                <div th:if="${session.member_id == post.member.getMemberId()}">
                    <button>수정</button>

                    <form th:action="@{/post/delete/{postId}(postId=${post.postId})}" method="post">
                        <input type="hidden" name="postId" th:value="${post.postId}" />
                        <input type="hidden" name="memberId" th:value="${post.member.memberId}" />
                        <button type="submit">삭제</button>
                    </form>
                </div>

                <div class="profile">
                    <img th:src="@{/image/cat.jpeg}" alt="프로필 사진">
                    <p>닉네임</p>
                </div>


                <h1 th:text="'제목 : ' + ${post.title}">제목</h1>
                <h3 th:text="'평점 : ' + ${post.grade}">평점</h3>
                <div id="heartContainer"></div>
                <h3 th:text="'총 경비 : ' + ${post.expense} + '원'">가격</h3>
                <div class="line" style="padding: 10px 2px">
                    <p class="nickname" th:text="'닉네임 : ' + ${post.member.getName()}">닉네임</p>
                    <img id="heartIcon" th:src="@{/image/red.png}" alt="heart" onclick="changeHeartIcon()">
                    <h3 class="line-item" th:text="${post.likeCount} + ' likes'">좋아요</h3>
                    <img th:src="@{/image/eye.png}" alt="eye">
                    <h3 class="line-item" th:text="${post.views} + ' views'">조회수</h3>
                </div>
                <p>여행 시작 날짜 : [[${#temporals.format(post.startTravelDate, 'yyyy-MM-dd')}]]</p>
                <p>여행 종료 날짜 : [[${#temporals.format(post.endTravelDate, 'yyyy-MM-dd')}]]</p>

                <hr>
                <p style="font-size: 20px" th:text="'여행지 후기 :' +${post.content}"></p>

                <div class="comment">
                </div>
                <h4 style="color: #c1c1c1;">댓글</h4>
                <div class="profile">
                    <img th:src="@{/image/cat.jpeg}" alt="프로필 사진">
                    <h4>김시언: 뭐요</h4>
                </div>
            </div>
        </div>
    </div>
</div>
<script>
    function changeHeartIcon() {
        var heartIcon = document.getElementById('heartIcon');
        var likeCount = document.getElementById('likeCount');

        if (heartIcon.src.includes('red.png')) {
            heartIcon.src = '../image/greyheart.png';
            likeCount.textContent = parseInt(likeCount.textContent) - 1;
        } else {
            heartIcon.src = '../image/red.png';
            likeCount.textContent = parseInt(likeCount.textContent) + 1;
        }
    }

    document.addEventListener("DOMContentLoaded", function () {
        displayHeartIcons([[${post.grade}]]);
    });
    form.addEventListener("submit", function(e) {
        e.preventDefault();
        const formData = new FormData(form);
        const postData = new URLSearchParams();

        for (const pair of formData.entries()) {
            postData.append(pair[0], pair[1]);
        }

        // 폼 데이터로부터 postId 추출
        const postId = formData.get("postId");

        fetch(`/post/comment?postId=${postId}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
            },
            body: postData
        })
            .then(response => response.json())
            .then(data => {
                if (data.id) { // 서버에서 응답받은 데이터에 id가 포함되어 있는 경우
                    const commentItem = document.createElement("li");
                    commentItem.textContent = `${data.authorName}: ${data.content}`; // 작성자 이름과 내용을 표시
                    commentList.appendChild(commentItem);
                    form.reset(); // 폼 초기화
                } else {
                    alert("Error: " + data.message);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert("Error posting comment: " + error.message);
            });
    });
</script>
</body>

</html>