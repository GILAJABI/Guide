<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <link rel="stylesheet" th:href="@{/css/post/reviewDetail.css}">
<!--    <script th:src="@{/js/post/reviewDetail.js}"></script>-->

    <script>
        var postId = `[[${post.postId}]]`;
        console.log("===============postId======================");
        console.log(postId);
        console.log("===========================================");

        document.addEventListener("DOMContentLoaded", function () {
            // 페이지 로드될 때 댓글을 가져오는 함수 호출
            loadComments(1);
        });

        // 댓글을 가져와서 HTML에 표시하는 함수
        function loadComments(page) {
            // Ajax를 사용하여 서버에서 특정 페이지의 댓글 데이터를 가져옵니다.
            fetch("/post/comment?postId=" + postId + "&page=" + page)
                .then(response => response.json()) // JSON 데이터로 변환
                .then(data => {
                    // 서버에서 받은 데이터를 처리하여 HTML에 표시
                    displayComments(data.dtoList);
                    // 페이징 버튼을 생성합니다.
                    displayPagination(data);
                })
                .catch(error => {
                    console.error('댓글을 불러오는 중 에러가 발생했습니다:', error);
                });
        }

        // 댓글을 HTML에 표시하는 함수
        function displayComments(comments) {
            var commentList = document.getElementById("commentList");
            commentList.innerHTML = ''; // 기존 댓글을 지웁니다.
            comments.forEach(function (comment) {
                var li = document.createElement('li');
                li.innerHTML = `
                    <p>${comment.member.name}: ${comment.commentContent} 등록일자: ${comment.registerDate}</p>
                `;
                commentList.appendChild(li);
            });
        }

        // 페이징 버튼을 생성하는 함수
        function displayPagination(data) {
            var pagination = document.getElementById("pagination");
            pagination.innerHTML = ''; // 기존 페이징 버튼을 지웁니다.

            var totalPages = Math.ceil(data.total / data.size); // 전체 페이지 수 계산

            for (var i = 1; i <= totalPages; i++) {
                var button = document.createElement('button');
                button.textContent = i;
                button.addEventListener("click", function () {
                    loadComments(this.textContent); // 버튼을 클릭하면 해당 페이지의 댓글을 가져옵니다.
                });
                pagination.appendChild(button);
            }
        }

        function displayHeartIcons(grade) {
            var heartContainer = document.getElementById("heartContainer");
            heartContainer.innerHTML = ''; // 이전에 추가된 하트 이미지를 모두 제거합니다.

            for (var i = 0; i < grade; i++) {
                var heartImage = document.createElement('img');
                heartImage.src = '/image/red.png'; // 하트 이미지 소스 설정
                heartImage.alt = 'heart'; // 대체 텍스트 설정
                heartContainer.appendChild(heartImage); // 하트 이미지를 하트 컨테이너에 추가합니다.
            }
        }
    </script>

    <style>
        #heartContainer {
            display: flex; /* 하트 이미지를 가로로 나열하기 위해 flex 사용 */
        }

        /* 하트 이미지에 대한 스타일 */
        #heartContainer img {
            width: 20px; /* 하트 이미지의 너비 */
            height: auto; /* 높이는 자동으로 조절되도록 설정 */
            margin-right: 5px; /* 각 하트 이미지 사이의 간격 설정 */
        }
    </style>
</head>

<body>

<div th:include="/include/header.html"></div>
<div class="container">
    <header>
        <div id="selectMenu">
            <a th:href="@{/post/joinMain}">모집</a>
            <a th:href="@{/post/reviewMain}">후기</a>
            <a th:href="@{/post/carrotMain}" style="color:#FF6392">상품</a>
        </div>
        <div id="selectMenu2">
            <div id="sortMenu">
                <a href="#" class="filter-link">최신순</a>
                <a href="#" class="filter-link">인기순</a>
                <a href="#" class="filter-link">많이 본 순</a>
                <a href="#" class="filter-link">댓글순</a>
            </div>
            <div id="use">
                <form>
                    <input type="text" name="query" id="searchInp">
                    <button type="submit" id="searchBtn">
                        <img th:src="@{/image/searchBtn.png}" alt="검색 버튼">
                    </button>
                </form>
                <button type="submit" id="postBtn">+ 올리기</button>
            </div>
        </div>
    </header>

<div class="cont">

    <div class="bottom">
        <div class="left">
            <th:block th:each="image : ${imageDTOS}">
                <img th:src="@{'/api/photo/' + ${image.uuid} + '_' + ${image.fileName}}"
                     alt="Uploaded Image"
                     th:onerror="@{/images/default.jpg}">
            </th:block>
            <div class="location-map">

                <iframe
                        src="https://www.google.com/maps/embed?pb=!1m18!1m12!1m3!1d35799.901099154966!2d126.99122613009443!3d37.52456387269132!2m3!1f0!2f0!3f0!3m2!1i1024!2i768!4f13.1!3m3!1m2!1s0x357ca15aee9ab0cb%3A0x31793fc63e0cf9d3!2z67mE7Yq47Lqg7ZSE!5e0!3m2!1sko!2skr!4v1709707618933!5m2!1sko!2skr"
                        width="600" height="450" style="border:0;" allowfullscreen="" loading="lazy"
                        referrerpolicy="no-referrer-when-downgrade"></iframe>
            </div>
        </div>

        <div class="right">
            <div th:if="${session.member_id == post.member.getMemberId()}">
                <button>수정</button>

                <form th:action="@{/post/delete/{postId}(postId=${post.postId})}" method="post">
                    <input type="hidden" name="postId" th:value="${post.postId}" />
                    <input type="hidden" name="memberId" th:value="${post.member.memberId}" />
                    <button type="submit">삭제</button>
                </form>
            </div>

            <div class="profile">
                <img th:src="@{/image/cat.jpeg}" alt="프로필 사진">
                <p>닉네임</p>
            </div>


            <h1 th:text="'제목 : ' + ${post.title}">제목</h1>
            <h3 th:text="'평점 : ' + ${post.grade}">평점</h3>
            <div id="heartContainer"></div>
            <h3 th:text="'총 경비 : ' + ${post.expense} + '원'">가격</h3>
            <div class="line" style="padding: 10px 2px">
                <p class="nickname" th:text="'닉네임 : ' + ${post.member.getName()}">닉네임</p>
                <img id="heartIcon" th:src="@{/image/red.png}" alt="heart" onclick="changeHeartIcon()">
                <h3 class="line-item" th:text="${post.likeCount} + ' likes'">좋아요</h3>
                <img th:src="@{/image/eye.png}" alt="eye">
                <h3 class="line-item" th:text="${post.views} + ' views'">조회수</h3>
            </div>
            <p>여행 시작 날짜 : [[${#temporals.format(post.startTravelDate, 'yyyy-MM-dd')}]]</p>
            <p>여행 종료 날짜 : [[${#temporals.format(post.endTravelDate, 'yyyy-MM-dd')}]]</p>

            <hr>
            <p style="font-size: 20px" th:text="'여행지 후기 :' +${post.content}"></p>

            <div class="comment">
            </div>
            <h4 style="color: #c1c1c1;">댓글</h4>
            <div class="profile">
                <img th:src="@{/image/cat.jpeg}" alt="프로필 사진">
                <h4>김시언: 뭐요</h4>
            </div>
        </div>
    </div>
</div>

<script>
    function changeHeartIcon() {
        var heartIcon = document.getElementById('heartIcon');
        var likeCount = document.getElementById('likeCount');

        if (heartIcon.src.includes('red.png')) {
            heartIcon.src = '../image/greyheart.png';
            likeCount.textContent = parseInt(likeCount.textContent) - 1;
        } else {
            heartIcon.src = '../image/red.png';
            likeCount.textContent = parseInt(likeCount.textContent) + 1;
        }
    }

    document.addEventListener("DOMContentLoaded", function () {
        displayHeartIcons([[${post.grade}]]);
    });
</script>
</div>

</body>

</html>